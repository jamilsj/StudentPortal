<!DOCTYPE HTML>
<html lang="en-US">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script>
   function startStream(){
      var videoSource = document.querySelector('select#videoSource').value;
      var constraints = {
         video: {
            deviceId: videoSource ? {exact: videoSource} : undefined, 
            width: 500,
            height: 500
         }
      };
      
      if(window.stream){
         window.stream.getTracks().forEach(function(track) {
            track.stop();
         });
      }

      navigator.getUserMedia(
         constraints,
         function(stream) {
            //
            var video = document.querySelector('video');

            //
            window.stream = stream;

            //
            video.src = window.URL.createObjectURL(stream);

            //
            video.onloadedmetadata = function(e) {
               video.play();
            };
         },
         function(err) {
            console.log("The following error occurred: " + err.name);
         }
      );
   }

   function listDevices (deviceInfos){
      //
      var videoSelect = document.querySelector('select#videoSource');

      //
      for (var i = 0; i !== deviceInfos.length; ++i) {
         var deviceInfo = deviceInfos[i];
         var option = document.createElement('option');
         option.value = deviceInfo.deviceId;

         // Only getting cameras. It can get microfone and speakers in the future
         if (deviceInfo.kind === 'audioinput') {
            //
         } else if (deviceInfo.kind === 'audiooutput') {
            //
         } else if (deviceInfo.kind === 'videoinput') {
            option.text = deviceInfo.label || 'camera ' + (videoSelect.length + 1);
            videoSelect.appendChild(option);
         } else {
            console.log('Some other kind of source/device: ', deviceInfo);
         }
      }
   }

   function doInitCamera(){
      //
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      
      //
      var videoSelect = document.querySelector('select#videoSource');

      //
      navigator.mediaDevices.enumerateDevices().then(listDevices).then(startStream).catch(function(error){
         console.log('navigator.getUserMedia error: ', error);
      });

      videoSelect.addEventListener("change", this.startStream);
   }

   function captureImage(){
      var video = document.querySelector('video');
      var canvas = document.querySelector('canvas');
      var ctx = canvas.getContext('2d');

      if (window.stream) {
         ctx.drawImage(video, 240, 0, 400, 400, 0, 0, 400, 400);
      }
   }
</script>
</head>
<body onload="doInitCamera()">  
   <div class="select">
      <label for="videoSource">Video source: </label><select id="videoSource"></select>
   </div>
   <div style="position:relative; padding:20px; display:inline-block;">
      <video id="video" style="width:100%; float:left;"></video>
      <div style="width: 100px;height:100px; position:absolute; border: 3px dotted white"></div>
   </div>
   <div style="position:relative">
      <button type="button" onclick="captureImage()">Capture!!!</button>
   </div>
   <div>
      <canvas width="400" height="400" style="border:1px solid black;"></canvas>
   </div>
</body>
</html>
