<!DOCTYPE HTML>
<html lang="en-US">
<head>
<script>
   function startStream(videoSelect){
      var videoSource = document.querySelector('select#videoSource').value;
      var constraints = {
         video: {deviceId: videoSource ? {exact: videoSource} : undefined}
      };

      navigator.getUserMedia(
         constraints,
         function(stream) {
            if(window.stream){
               window.stream.getTracks().forEach(function(track) {
                  track.stop();
               });
            } 
            window.stream = stream;
            
            video.src = window.URL.createObjectURL(stream);
            video.onloadedmetadata = function(e) {
               video.play();
            };
         },
         function(err) {
            console.log("The following error occurred: " + err.name);
         }
      );
   }

   function doIniCamera(){
      // TO DO - Implement better way
      // debugger;
      // document.getElementById('video-container').innerHTML = '<div class="select">' +
      //    '<label for="videoSource">Video source: </label><select id="videoSource"></select>' +
      //    '</div><video id="video" width="' + (Ext.getBody().getWidth() - 50) + '" height="' + (Ext.getBody().getHeight() - 50) + '" autoplay></video>';

      //
      navigator.getUserMedia = navigator.getUserMedia ||
         navigator.webkitGetUserMedia ||
         navigator.mozGetUserMedia;

      //
      var video = document.querySelector('video');
      var videoSelect = document.querySelector('select#videoSource');

      //
      navigator.mediaDevices.enumerateDevices().then(function(deviceInfos){
         for (var i = 0; i !== deviceInfos.length; ++i) {
            var deviceInfo = deviceInfos[i];
            var option = document.createElement('option');
            option.value = deviceInfo.deviceId;

            // Only getting cameras. It can get microfone and in the future
            if (deviceInfo.kind === 'audioinput') {
               //
            } else if (deviceInfo.kind === 'audiooutput') {
               //
            } else if (deviceInfo.kind === 'videoinput') {
               option.text = deviceInfo.label || 'camera ' + (videoSelect.length + 1);
               videoSelect.appendChild(option);
            } else {
               console.log('Some other kind of source/device: ', deviceInfo);
            }
         }
      }).catch(function(error){
         console.log('navigator.getUserMedia error: ', error);
      });

      videoSelect.addEventListener("change", this.startStream);

      this.startStream();
   }  
   // doIniCamera();
</script>
</head>
<body onload="doIniCamera()">
   <div class="select">
      <label for="videoSource">Video source: </label><select id="videoSource"></select>
   </div>
   <video id="video" width="100" height="100" autoplay></video>
</body>
</html>
